<hi:common_header runat="server" />
<link rel="stylesheet" href="../style/pcOrder.css" rev="stylesheet" type="text/css">
<link rel="stylesheet" href="../style/classify.css" rev="stylesheet" type="text/css">
<div class="container-m">
    <!--<div class="header-top"></div>-->
    
    <div class="classify orders-list-classify clear" id="classify">
      <div class="top-nav box" style="min-height:64em;">
          <ul id="flipBtn">
              <li class="prev"><img src="/images/step_shang11.png" /></li>
              <li class="next"><img src="/images/step_xia11.png" /></li>
          </ul>
        <div class="categoriArea"><ul id="categoriArea"> 
          <hi:vshoptemplatedrepeater id="rptCategories" templatefile="/Tags/skin-Common_PCNewCategoriesBuy.ascx"   runat="server" />
        </ul></div>
       </div>
      <div class="pro-list box" style="min-height:64em;">
          <ul class="orders-rlistbox-ul">
            <!--<li><a href=""> <img src="../images/pic.jpg"><span>时尚秋裤</span></a></li>-->
            <hi:vshoptemplatedrepeater id="rptProducts" templatefile="/Tags/skin-Common_PCNewProdctsShow.ascx" runat="server" />
          </ul>
          <div id="pager"></div>
          <!--<div class="addan">

          </div>-->
          <ul class="addan">
              <li class="firstB coommon Wbottom"><%<asp:literal runat="server" id="litBuyToGive"/>%></li>
              <li class="secondS coommon Wbottom"><%<asp:literal runat="server" id="litHalf"/>%></li>
              <li class="coommon Wbottom"><a class="account-all" id="btnClear" onclick="Clear()">清除</a></li>
              <li class="coommon Wbottom"><a class="account-all" id="btnDiscount" >优惠</a></li>
              <li class="wxPay" ><a class="account-all" id="btnMicroPay" onclick="ThirdPay()" <!--onclick="OpenMicroPay()"-->第三方支付</a></li>
              <!--<li><a class="account-all" id="enterCouponCode" onclick="showCoupon()">优惠券</a></li>-->
          </ul>
        </div>
      </div>
     <!--<div class="classifyItem">
        
      </div>-->
    
    <div class="left-nav">
        <span class="hwbg-rt"></span>
        <div class="left-nav-border">
            <div class="top"><a href="javascript:window.close()"><img src="/images/sswlogo.png" /></a><p style="line-height: 1;"><asp:literal id="litStoreName" runat="server"></asp:literal></p></div>
            <!--order列表 -->
            <div id="orderList">
                <div class="orderList-tit"><span>菜品</span><span>数量</span></div>
                <ul>
                    <asp:literal runat="server" id="litOrderList"/>
                </ul>
            </div>
            <div class="account" >
                <a class="account-all" href="#" ><span>总计</span><span id="priceTotal"></span></a>
                <a class="btn-buy" id="btnSubmmit" href="javascript:void(0)" onclick="btnBuy()"><img src="/images/js.png" /></a>
            </div>
        </div>
        <span class="hwbg-lb"></span>
    </div>
   <!--第三方支付-->
<div class="payThird-Box">
    <p class="paybg paybgTop">
        <div class="ptitle">第三方支付</div>
         <div class="payBtn"><img src="/images/closeT2.png" onclick="closeThirdPayDiv()"/></div>
    </p>
    <ul class="payThirdUl">
        <li class="labelLi"><label>支付途径:</label><div class="typeT type1" role="thirdWayList"></div></li>
        <li role="thirdWayDisList" ></li>
        <li class="Csecond"><label class="Clabel">应&nbsp;&nbsp;收:</label><p id="payYS">123</p></li>
        <li class="labelLi"><label class="labelF">优&nbsp;&nbsp;惠:</label><div class="typeT type2 typeF"><input type="text" id="thirdPayDiscount" value=""/></li>
        <li><label class="Clabel">实&nbsp;&nbsp;收:</label><div class="Cinput"><input type="text" id="thirdPayCash" value=""/></div></li>
        <li class="confirmLi" onclick="thirdPaySubmmitOrder()"><a href="#">已完成</a></li>
    </ul>
    <p class="paybg paybgBottom"></p>
</div>
<!--第三方支付-->
    <!--结算的弹窗-->
<div class="sumCount-Box">
    <p class="paybg paybgTop">
        <div class="ptitle">结算预览</div>
      <!--  <div class="closeBtn"><img src="/images/closeT2.png" /></div>-->
        <div class="payBtn"><img src="/images/closeT2.png" onclick="closeThirdPayDiv()"/></div>
    </p>
    <div class="sumCount">
        <div class="buy_1 buy_comm">
            <label>应&nbsp;&nbsp;收:</label><input id="comid" type="text"/>
        </div>
         <div class="buyN">优&nbsp;&nbsp;惠:</div>
        <div class="buy_2">
            <span id="strDiscount" ></span>
            <!--<div class="type3"><input type="checkbox"/>5元<input type="checkbox"/>10元<input type="checkbox"/>15元</div>-->
        </div>
        <div class="sumF buy_3">
            <div class="xianjin" onclick="btnBuyCom()"><a href="#">现金</a></div>
            <div class="saoma" onclick="showMicropay()"><a href="#">微信扫码</a></div>
        </div>
    </div>
    <p class="paybg paybgBottom"></p>
</div>
<!--结算的弹窗-->
<!--确认结算的弹窗-->
<div class="sumCof-Box">
    <p class="paybg paybgTop">
        <div class="ptitle">现金支付</div>
        <div class="payBtn"><img src="/images/closeT2.png" onclick="closeThirdPayDiv()"/></div>
    </p>
    <ul class="sumCofUl">
        <li><label>应收:</label><p class="Spay" id="Spay"></p></li>
        <li>实付:<input type="text" id="Sshi"/></li>
        <li><label>找零:</label><p class="coin" id="Sling"></p></li>
        <li class="closeLi" onclick="submmitorder()">确&nbsp;认</li>
    </ul>
    <p class="paybg paybgBottom"></p>
</div>
<!--确认结算的弹窗-->
</div>
<!--优惠券输入框-->
<div class="coupon" id="divActivity">
    <!--<p class="title">优惠券<span>X</span></p>-->
    <div>
        <input id="txtCouponCode" type="text" class="ui-keyboard-input ui-widget-content ui-corner-all" aria-haspopup="true" role="textbox">
        <a class="sure" id="accept" style="display:none">使用</a>
    </div>
</div>
<!--优惠输入框-->


<div class="coupon" id="divDiscount">
    <div>
        <input id="txtDiscount" type="text" class="ui-keyboard-input ui-widget-content ui-corner-all" aria-haspopup="true" role="textbox">
    </div>
</div>
<!--现金输入框-->
<div class="coupon" id="divCash">
    <div>
        <span>请输入现金</span>
        <input id="txtCashInput" type="text" class="ui-keyboard-input ui-widget-content ui-corner-all" aria-haspopup="true" role="textbox">
    </div>
</div>
<!--规格选择框-->
<div id="skuSelectorDiv" productId="0"></div> <div id="bg"></div>
<!--刷卡支付弹出扫码框-->
<div id="MicroPay" style="display:none">
    <p>请扫码</p>
    <input type="text" id="txtPayCode" onBlur="this.focus()"/>
    <input type="hidden" id="hidOrderId" />
</div>
<div id="MicroPayDiv" style="display:none"></div><!--刷卡支付的返回html-->
<div id="printDiv" style="display:none"></div>
<input type="hidden" runat="server"   id="litCategoryId" />
<input type="hidden" runat="server"   id="txtTotal" />
<input type="hidden" runat="server"   id="defaultShippingtype" />
<input type="hidden" runat="server"   id="txtStoreId" />
<input type="hidden" runat="server"   id="txtThirdWayDiscountInfo" />

<script type="text/javascript" src="../script/jquery1.42.min.js"></script>
<script src="../script/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="../script/jquery.SuperSlide.2.1.js"></script>
<script type="text/javascript">jQuery("#classify").slide();</script>
<script type="text/javascript" src="../script/jQuery.equalHeights.js"></script>
<!-- 打印机控件引用-->
<script language="javascript" src="../script/LodopFuncs.js?v=1.1"></script>
<object  id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width=0 height=0> 
       <embed id="LODOP_EM" type="application/x-print-lodop" width=0 height=0></embed>
</object>
<!--虚拟小键盘控件引用-->
<!-- jQuery & jQuery UI + theme (required) -->
<link href="../style/jquery-ui.css" rel="stylesheet">
<script src="../script/jquery-ui.min.js"></script>
<link href="../style/keyboard.css" rel="stylesheet">
<script src="../script/jquery.keyboard.min.js"></script>


<!--分页-->
<script src="/Utility/common.js" type="text/javascript"></script>
<script src="/Utility/pager.js" type="text/javascript"></script>
<script src="../script/PCorder.Helper.js?v=7"></script>
<script type="text/javascript">
    vshopPager('pager', $('#PCProductSearchBuy_txtTotal').val(), 1, 16);
    $("#pager").show();
</script>
<!-- 分页-->
<script type="text/javascript">
    $(function () { $('#classify').equalHeights(); });
</script>

 

<script type="text/javascript">
    function goUrl(url) {
        location.replace(url);
    }

    //wj----------------------------------------------------wj//
    $(function () {
        var string = window.location.href;//获取url地址
        var index = string.indexOf("=");//indexOf()返回字符串指定出现的位置
        var str = string.substring(index + 1, string.length);//substring()方法用于提取字符串中介于两个指定下标之间的字符。
        var num = str.replace(/[^0-9]/ig, ""); //从字符串中取数字

        var len = $("#categoriArea li").length;
        var v_height = $("#categoriArea li").height();
        var num1 = len - 1;
        var end_pos = -(v_height * (len - num1)) + 'px';

        $("#categoriArea").height(len * 80);

        //当前页：定位+样式
        $("#categoriArea li").each(function () {
            $(this).addClass("a " + $(this).index());
            var arr = $(".a");

            var $id = $(this).attr("id");

            if ($id == num) {
                $(this).css("background-color", "#6c5239");

                var b = $(this).index();
                var c = arr.index($("." + b));

                if (b == 0) {
                    $("#categoriArea").css("top", "0px");
                } else if (b == (len - 1)) {
                    $("#categoriArea").css("top", -(v_height * (b - 2)));
                } else {
                    $("#categoriArea").css("top", -(v_height * (b - 1)));
                }
            }
        })
        //翻页
        $("#flipBtn li").click(function () {
            var $top = $("#categoriArea").css("top");

            if ($(this).attr("class") == "prev") {
                if (!$("#categoriArea").is(":animated")) {
                    if ($top == end_pos) {
                        $("#categoriArea").animate({ top: "0px" }, "slow");
                    } else {
                        $("#categoriArea").animate({ top: '+=' + v_height + 'px' }, "slow");
                    }
                }
            }
            if ($(this).attr("class") == "next") {
                if (!$("#categoriArea").is(":animated")) {
                    if ($top == '0px') {
                        $("#categoriArea").animate({ top: end_pos }, "slow");
                    } else {
                        $("#categoriArea").animate({ top: '-=' + v_height + 'px' }, "slow");
                    }
                }
            }
        });
        //wj----------------------------------------------------wj//

        var categoryItems = $('a.categoryItem');
        var cateogryId, url;
        $.each(categoryItems, function (i, item) {
            cateogryId = $(item).attr('value');
            if ($(item).attr('name') == "True")
                url = '?categoryId=' + cateogryId;
            else
                url = '/Vshop/ProductList.aspx?categoryId=' + cateogryId;
            $(item).attr('onclick', 'goUrl("' + url + '")').attr('href', 'javascript:;');

        });

        $(".pbox-select-tags li .select-tags-img").height($(".pbox-select-tags li .select-tags-img").width());

        //载入第三方支付方式和满减内容
        loadThirdWayInfo();
    });
    //结算
    function btnBuy() {
        //打开支付信息预览窗口
            var len = document.getElementById("priceTotal").innerHTML.length;
            var xianJ11 = document.getElementById("priceTotal").innerHTML.substring(1,len);
            var xianJ22 = document.getElementById("comid");
            xianJ22.value = xianJ11+"元";
            //alert(xianJ11);
            $(".sumCount-Box").css("display", "block");
            $(".type3").find('input[type=checkbox]').bind('click', function () {
                $(".type3").find('input[type=checkbox]').not(this).attr("checked", false);
            });
        };
    //现金页面
    function btnBuyCom() {
        //打开窗口
        var len1 = document.getElementById("priceTotal").innerHTML.length;
        var xianJ1 = document.getElementById("priceTotal").innerHTML.substring(1,len1);
        var xianJ2 = document.getElementById("Spay");
        xianJ2.innerHTML = xianJ1 + "元";

        $(".sumCount-Box").css("display", "none");
        $(".sumCof-Box").css("display", "block");
        //关闭窗口
         $('#Sshi').focus();//呼出虚拟键盘
    }
    function closeLL() {
        $(".sumCof-Box").css("display", "none");
    }

    function calmThirdwayDiscount() {

    }
    var thirdDisMoney = 0;
    //第三方支付
    function ThirdPay() {
        //打开窗口
        //event.preventDefault();
        //先清空
        $("#thirdPayDiscount").val("");
        $("#thirdPayCash").val("");
        $(".payThirdUl").find("input[type=checkbox]").attr("checked", false);
        thirdDisMoney = 0;

        //显示遮罩层
        $("#bg").css({ display: "block", height: $(document).height() });
        var pay1 = document.getElementById("priceTotal").innerHTML;
        var pay2 = document.getElementById("payYS");
        pay2.innerHTML = pay1;
        //alert(pay1);
        //选择控制
        $(".type1").find('input[type=checkbox]').bind('click', function () {

            $(".type1").find('input[type=checkbox]').not(this).attr("checked", false);
            $("[role='thirdWayDisList']").find("[role='thirdWay_" + $(this).val() + "']").show();
            $("[role='thirdWayDisList']").find("k:not([role='thirdWay_" + $(this).val() + "'])").hide();
        });
        $("k").find('input[type=checkbox]').change(function () {
            $("k").find('input[type=checkbox]:checked').not(this).attr("checked",false);
            
            //判断是否达到满减
            $("#payYS").html("￥" + (parseFloat($("#payYS").html().replace("￥", "")) + thirdDisMoney)); thirdDisMoney = 0; //每次点击时,将之前满减的钱加回来,
            var ysMoney = parseFloat($("#payYS").html().replace("￥", ""));
            var reachMoney = parseFloat($(this).attr("reachMoney"));
            var discountMoney = parseFloat($(this).attr("discountMoney"));
            if (ysMoney >= reachMoney) {
                if ($(this).attr("checked") == "checked") {
                    $("#payYS").html("￥" + (ysMoney - discountMoney));
                    thirdDisMoney += discountMoney;
                }
                $("#thirdPayDiscount").val("");
                $("#thirdPayCash").val("");
            }
            
        });

        /*
        $("k").find('input[type=checkbox]').bind('click', function () {
            $("k").find('input[type=checkbox]').not(this).attr("checked", false);
            //判断是否达到满减
            var ysMoney = parseFloat($("#payYS").html().replace("￥", ""));
            var reachMoney = parseFloat($(this).attr("reachMoney"));
            var discountMoney = parseFloat($(this).attr("discountMoney"));
            if (ysMoney >= reachMoney) {
                if ($(this).attr("checked") == "checked") {
                    $("#payYS").html("￥" + (ysMoney - discountMoney));
                }
                else {
                    $("#payYS").html("￥" + (ysMoney + discountMoney));
                }
            }
        });
        */


        $(".type2").find('input[type=checkbox]').bind('click', function () {
        $(".type2").find('input[type=checkbox]').not(this).attr("checked", false);
        });   
        //显示
        $(".payThird-Box").css("display", "block");
    }  
    function closeTHid() {
        $(".payThird-Box").css("display", "none");
    }

    function loadThirdWayInfo() {
        //<input type="checkbox" chk="thirdWay" value="美团"/>美团<input type="checkbox" chk="thirdWay" value="大众"/>大众<input type="checkbox" chk="thirdWay" value="饿了么"/>饿了么</div>
        var sbjList = $("#PCProductSearchBuy_txtThirdWayDiscountInfo").val().split(';');//题目列
        var inputHtml = "";//第三方支付方式html
        var kHtml = "";//第三方满减活动html
        for (var i = 1; i <= sbjList.length; i++) {
            var valueList = sbjList[i - 1].split(',');
            inputHtml += '<input type="checkbox" chk="thirdWay" value="' + valueList[0] + '"/>' + valueList[0];
            

            for (var o = 1; o < valueList.length; o++) {
                if (o % 2 == 1) {
                    kHtml += "<k style='display:none' role='thirdWay_" + valueList[0] + "' >";
                    kHtml += '<input type="checkbox" chk="thirdWay_chk_' + valueList[0] + '"  reachMoney="' + valueList[o] + '" discountMoney="' + valueList[o + 1] + '"/> 满' + valueList[o];
                }
                else {
                    kHtml += "减" + valueList[o] + "</k>";
                }
            }
            
        }
        $("[role='thirdWayDisList']").append(kHtml);
        $("[role='thirdWayList']").append(inputHtml);
    }
</script>

